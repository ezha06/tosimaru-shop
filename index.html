<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produk Terdekat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f6f6;
      margin: 0;
      padding: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }
    .card-body { padding: 8px; }
    .title { font-weight: 600; font-size: 14px; margin-bottom: 4px; color: #222; }
    .price { color: #16a34a; font-weight: 600; font-size: 13px; }
    .meta { font-size: 12px; color: #666; margin-top: 4px; }
  </style>
</head>
<body>
  <div id="produkGrid" class="grid">Menunggu izin lokasi...</div>

<script>
const API_TOKO = "https://app.jagel.id/api/v2/customer/list/68b8337397337?codename=tosimaru";
const API_PRODUK = "https://app.jagel.id/api/v2/customer/list/68b8337397337/children?codename=tosimaru";

function hitungJarak(lat1, lon1, lat2, lon2) {
  const R = 6371, toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function formatHarga(nilai, currency) {
  if (!nilai && nilai !== 0) return "";
  return (currency || "Rp") + " " + Number(nilai).toLocaleString("id-ID");
}

function renderProduk(list, jarak) {
  const grid = document.getElementById("produkGrid");
  grid.innerHTML = list.map(p => `
    <a class="card" href="action://p/${p.view_uid}">
      <img src="https://www.jagel.id/api/listimage/${p.image}" alt="${p.title}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
      <div class="card-body">
        <div class="title">${p.title}</div>
        <div class="price">${formatHarga(p.price, p.currency)}</div>
        <div class="meta">üìç ${jarak.toFixed(2)} km</div>
      </div>
    </a>
  `).join("");
}

navigator.geolocation.getCurrentPosition(async pos => {
  const userLat = pos.coords.latitude;
  const userLon = pos.coords.longitude;

  try {
    const [tokoRes, produkRes] = await Promise.all([
      fetch(API_TOKO),
      fetch(API_PRODUK)
    ]);

    const tokoData = await tokoRes.json();
    const produkData = await produkRes.json();

    const toko = tokoData.data;
    const produkList = produkData.data.data || [];

    const jarak = hitungJarak(userLat, userLon, parseFloat(toko.origin_lat), parseFloat(toko.origin_lng));
    renderProduk(produkList, jarak);

  } catch (err) {
    console.error(err);
    document.getElementById("produkGrid").innerHTML = "<p>‚ùå Gagal memuat produk.</p>";
  }
}, err => {
  document.getElementById("produkGrid").innerHTML = "<p>‚ùå Lokasi tidak diizinkan.</p>";
});
</script>
</body>
</html>